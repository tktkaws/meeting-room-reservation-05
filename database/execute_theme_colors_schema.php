<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉÜ„Éº„Éû„Ç´„É©„ÉºÊ©üËÉΩ„Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .sql-content {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® „ÉÜ„Éº„Éû„Ç´„É©„ÉºÊ©üËÉΩ„Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞</h1>
        
        <?php
        // „Éá„Éº„Çø„Éô„Éº„ÇπË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        require_once '../api/config.php';
        
        $executed = false;
        $results = [];
        
        if (isset($_POST['execute'])) {
            $executed = true;
            
            try {
                // SQL„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø
                $sqlFile = __DIR__ . '/update_theme_colors_schema.sql';
                
                if (!file_exists($sqlFile)) {
                    throw new Exception("SQL„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: $sqlFile");
                }
                
                $sqlContent = file_get_contents($sqlFile);
                if ($sqlContent === false) {
                    throw new Exception("SQL„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                }
                
                // „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö
                $pdo = getDatabase();
                $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                
                // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                $colorColumnExists = false;
                $userDepartmentColorsTableExists = false;
                
                try {
                    // departments„ÉÜ„Éº„Éñ„É´„ÅÆcolor„Ç´„É©„É†Â≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
                    $stmt = $pdo->query("PRAGMA table_info(departments)");
                    $columns = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    foreach ($columns as $column) {
                        if ($column['name'] === 'color') {
                            $colorColumnExists = true;
                            break;
                        }
                    }
                    
                    // user_department_colors„ÉÜ„Éº„Éñ„É´Â≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
                    $stmt = $pdo->query("SELECT name FROM sqlite_master WHERE type='table' AND name='user_department_colors'");
                    $userDepartmentColorsTableExists = $stmt->fetch() !== false;
                    
                } catch (Exception $e) {
                    $results[] = [
                        'type' => 'warning',
                        'sql' => 'Database structure check',
                        'message' => '„Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó: ' . $e->getMessage()
                    ];
                }
                
                $results[] = [
                    'type' => 'info',
                    'sql' => '',
                    'message' => sprintf('ÁèæÂú®„ÅÆÁä∂ÊÖã: color„Ç´„É©„É†=%s, user_department_colors„ÉÜ„Éº„Éñ„É´=%s', 
                        $colorColumnExists ? 'Â≠òÂú®' : 'Êú™Â≠òÂú®',
                        $userDepartmentColorsTableExists ? 'Â≠òÂú®' : 'Êú™Â≠òÂú®'
                    )
                ];
                
                // SQL„ÇíË°å„Åî„Å®„Å´ÂàÜÂâ≤„Åó„Å¶ÂÆüË°å
                $sqlStatements = explode(';', $sqlContent);
                
                $successCount = 0;
                $errorCount = 0;
                
                foreach ($sqlStatements as $statement) {
                    $statement = trim($statement);
                    
                    // Á©∫„ÅÆË°å„ÇÑ„Ç≥„É°„É≥„ÉàË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                    if (empty($statement) || strpos($statement, '--') === 0) {
                        continue;
                    }
                    
                    try {
                        // ÁâπÂÆö„ÅÆÊù°‰ª∂„Åß„Çπ„Ç≠„ÉÉ„ÉóÂá¶ÁêÜ
                        $shouldSkip = false;
                        $skipReason = '';
                        
                        // ALTER TABLEÊñá„Åßcolor„Ç´„É©„É†„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà
                        if (strpos($statement, 'ALTER TABLE departments ADD COLUMN color') !== false && $colorColumnExists) {
                            $shouldSkip = true;
                            $skipReason = 'color„Ç´„É©„É†„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô';
                        }
                        
                        // user_department_colors„ÉÜ„Éº„Éñ„É´„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê„Åß„ÄÅ„ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà
                        if (strpos($statement, 'user_department_colors') !== false && 
                            strpos($statement, 'CREATE INDEX') !== false && 
                            !$userDepartmentColorsTableExists) {
                            $shouldSkip = true;
                            $skipReason = 'user_department_colors„ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê„Çí„Çπ„Ç≠„ÉÉ„Éó';
                        }
                        
                        // UPDATEÊñá„Åßcolor„Ç´„É©„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà
                        if (strpos($statement, 'UPDATE departments SET color') !== false && !$colorColumnExists) {
                            $shouldSkip = true;
                            $skipReason = 'color„Ç´„É©„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅUPDATEÊñá„Çí„Çπ„Ç≠„ÉÉ„Éó';
                        }
                        
                        if ($shouldSkip) {
                            $results[] = [
                                'type' => 'warning',
                                'sql' => $statement,
                                'message' => '„Çπ„Ç≠„ÉÉ„Éó: ' . $skipReason
                            ];
                            continue;
                        }
                        
                        $stmt = $pdo->prepare($statement);
                        $stmt->execute();
                        
                        // ÂÆüË°åÊàêÂäüÂæå„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                        if (strpos($statement, 'ALTER TABLE departments ADD COLUMN color') !== false) {
                            $colorColumnExists = true;
                        }
                        if (strpos($statement, 'CREATE TABLE IF NOT EXISTS user_department_colors') !== false) {
                            $userDepartmentColorsTableExists = true;
                        }
                        
                        $results[] = [
                            'type' => 'success',
                            'sql' => $statement,
                            'message' => 'ÂÆüË°åÊàêÂäü'
                        ];
                        $successCount++;
                        
                    } catch (PDOException $e) {
                        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                        if (strpos($e->getMessage(), 'duplicate column name') !== false || 
                            strpos($e->getMessage(), 'table user_department_colors already exists') !== false ||
                            strpos($e->getMessage(), 'already exists') !== false ||
                            strpos($e->getMessage(), 'no such column: color') !== false ||
                            strpos($e->getMessage(), 'no such table') !== false) {
                            
                            $results[] = [
                                'type' => 'warning',
                                'sql' => $statement,
                                'message' => '„Çπ„Ç≠„ÉÉ„Éó: ' . $e->getMessage()
                            ];
                        } else {
                            $results[] = [
                                'type' => 'error',
                                'sql' => $statement,
                                'message' => '„Ç®„É©„Éº: ' . $e->getMessage()
                            ];
                            $errorCount++;
                        }
                    }
                }
                
                // ÂÆüË°åÁµêÊûú„Çµ„Éû„É™„Éº
                if ($errorCount === 0) {
                    echo '<div class="status success">';
                    echo '<h3>‚úÖ „Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞ÂÆå‰∫Ü</h3>';
                    echo '<p>„Åô„Åπ„Å¶„ÅÆSQLÊñá„ÅåÊ≠£Â∏∏„Å´ÂÆüË°å„Åï„Çå„Åæ„Åó„Åü„ÄÇ</p>';
                    echo '<p>ÊàêÂäü: ' . $successCount . '‰ª∂</p>';
                    echo '</div>';
                } else {
                    echo '<div class="status warning">';
                    echo '<h3>‚ö†Ô∏è „Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞ÂÆå‰∫ÜÔºà‰∏ÄÈÉ®„Ç®„É©„Éº„ÅÇ„ÇäÔºâ</h3>';
                    echo '<p>ÊàêÂäü: ' . $successCount . '‰ª∂, „Ç®„É©„Éº: ' . $errorCount . '‰ª∂</p>';
                    echo '</div>';
                }
                
            } catch (Exception $e) {
                echo '<div class="status error">';
                echo '<h3>‚ùå „Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞Â§±Êïó</h3>';
                echo '<p>„Ç®„É©„Éº: ' . htmlspecialchars($e->getMessage()) . '</p>';
                echo '</div>';
            }
        }
        
        if (!$executed) {
            // ÂÆüË°åÂâç„ÅÆÁ¢∫Ë™çÁîªÈù¢
            echo '<div class="status info">';
            echo '<h3>üìã ÂÆüË°å‰∫àÂÆö„ÅÆSQL</h3>';
            echo '<p>‰ª•‰∏ã„ÅÆSQLÊñá„ÇíÂÆüË°å„Åó„Å¶„ÉÜ„Éº„Éû„Ç´„É©„ÉºÊ©üËÉΩ„ÅÆ„Éá„Éº„Çø„Éô„Éº„Çπ„Çπ„Ç≠„Éº„Éû„ÇíÊõ¥Êñ∞„Åó„Åæ„ÅôÔºö</p>';
            
            $sqlFile = __DIR__ . '/update_theme_colors_schema.sql';
            if (file_exists($sqlFile)) {
                $sqlContent = file_get_contents($sqlFile);
                echo '<div class="sql-content">' . htmlspecialchars($sqlContent) . '</div>';
                
                echo '<div class="status warning">';
                echo '<h4>‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö</h4>';
                echo '<ul>';
                echo '<li>„Åì„ÅÆÊìç‰Ωú„ÅØ„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÊßãÈÄ†„ÇíÂ§âÊõ¥„Åó„Åæ„Åô</li>';
                echo '<li>Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Å´„ÅØÂΩ±Èüø„Åó„Åæ„Åõ„Çì„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÊé®Â•®„Åó„Åæ„Åô</li>';
                echo '<li>Êó¢„Å´„Çπ„Ç≠„Éº„Éû„ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ‰∏ÄÈÉ®„ÅÆÊìç‰Ωú„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åô</li>';
                echo '</ul>';
                echo '</div>';
                
                echo '<form method="post">';
                echo '<button type="submit" name="execute" class="btn">üöÄ „Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞„ÇíÂÆüË°å</button>';
                echo '</form>';
            } else {
                echo '<div class="status error">';
                echo '<p>SQL„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ' . htmlspecialchars($sqlFile) . '</p>';
                echo '</div>';
            }
            echo '</div>';
        } else {
            // ÂÆüË°åÁµêÊûú„ÅÆË©≥Á¥∞Ë°®Á§∫
            echo '<h3>üìù ÂÆüË°å„É≠„Ç∞</h3>';
            
            foreach ($results as $result) {
                $statusClass = $result['type'];
                echo "<div class='status $statusClass'>";
                echo "<h4>" . ucfirst($result['type']) . "</h4>";
                echo "<p><strong>„É°„ÉÉ„Çª„Éº„Ç∏:</strong> " . htmlspecialchars($result['message']) . "</p>";
                echo "<p><strong>SQL:</strong></p>";
                echo "<pre>" . htmlspecialchars($result['sql']) . "</pre>";
                echo "</div>";
            }
            
            echo '<div style="margin-top: 30px;">';
            echo '<a href="' . $_SERVER['PHP_SELF'] . '" class="btn">üîÑ ÂÜçÂÆüË°å</a>';
            echo '<a href="../admin/department_management.html" class="btn">üè¢ ÈÉ®ÁΩ≤ÁÆ°ÁêÜ„Å∏</a>';
            echo '<a href="../index.html" class="btn">üè† „Éõ„Éº„É†„Å∏</a>';
            echo '</div>';
        }
        ?>
        
        <hr style="margin: 30px 0;">
        
        <h3>üîß „Éá„Éº„Çø„Éô„Éº„ÇπÊÉÖÂ†±</h3>
        <?php
        try {
            $pdo = getDatabase();
            
            // „Éá„Éº„Çø„Éô„Éº„Çπ„Éï„Ç°„Ç§„É´„ÅÆÂ†¥ÊâÄ
            echo '<p><strong>„Éá„Éº„Çø„Éô„Éº„Çπ„Éï„Ç°„Ç§„É´:</strong> ' . htmlspecialchars(DB_PATH) . '</p>';
            
            // ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß
            $stmt = $pdo->query("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
            $tables = $stmt->fetchAll(PDO::FETCH_COLUMN);
            
            echo '<p><strong>ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éñ„É´:</strong></p>';
            echo '<ul>';
            foreach ($tables as $table) {
                echo '<li>' . htmlspecialchars($table) . '</li>';
            }
            echo '</ul>';
            
            // departments„ÉÜ„Éº„Éñ„É´„ÅÆÊßãÈÄ†Á¢∫Ë™ç
            if (in_array('departments', $tables)) {
                echo '<p><strong>departments„ÉÜ„Éº„Éñ„É´„ÅÆÊßãÈÄ†:</strong></p>';
                $stmt = $pdo->query("PRAGMA table_info(departments)");
                $columns = $stmt->fetchAll(PDO::FETCH_ASSOC);
                
                echo '<pre>';
                foreach ($columns as $column) {
                    echo htmlspecialchars($column['name']) . ' (' . htmlspecialchars($column['type']) . ')' . "\n";
                }
                echo '</pre>';
            }
            
        } catch (Exception $e) {
            echo '<div class="status error">';
            echo '<p>„Éá„Éº„Çø„Éô„Éº„ÇπÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó: ' . htmlspecialchars($e->getMessage()) . '</p>';
            echo '</div>';
        }
        ?>
        
    </div>
</body>
</html>