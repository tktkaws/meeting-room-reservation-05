<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÉ®ÁΩ≤ÁÆ°ÁêÜ - ‰ºöË≠∞ÂÆ§‰∫àÁ¥Ñ„Ç∑„Çπ„ÉÜ„É†</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div id="app">
        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <!-- „Çµ„Ç§„Éâ„Éê„Éº„Éò„ÉÉ„ÉÄ„Éº -->
                <div class="sidebar-header">
                    <h1 class="sidebar-title">
                        <a href="../index.html">üìÖ ‰ºöË≠∞ÂÆ§‰∫àÁ¥Ñ„Ç∑„Çπ„ÉÜ„É†</a>
                    </h1>
                    <button type="button" id="hamburger-close-btn" class="hamburger-close-btn">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="sidebar-section sidebar-user-info" id="sidebar-user-section" style="display: none;">
                    <div class="sidebar-user-card">
                        <div class="sidebar-user-details">
                            <img src="images/person.svg" alt="" class="material-icon">
                            <span class="sidebar-user-name" id="sidebar-user-info"></span>
                        </div>
                        <div class="sidebar-user-details">
                            <img src="images/groups.svg" alt="" class="material-icon">
                            <span id="sidebar-department-name"></span>
                        </div>
                    </div>

                    <!-- „ÉÜ„Éº„Éû„Ç´„É©„ÉºË®≠ÂÆö -->
                    <div id="sidebar-theme-color-controls" class="sidebar-theme-colors" style="display: none;">
                        <div class="sidebar-section-title">„ÉÜ„Éº„Éû„Ç´„É©„ÉºË®≠ÂÆö</div>
                        <div id="user-theme-color-setting" class="theme-color-setting">
                            <div class="theme-color-row">
                                <label for="user-theme-color">„ÅÇ„Å™„Åü„ÅÆ„ÉÜ„Éº„Éû„Ç´„É©„Éº:</label>
                                <div class="theme-color-controls">
                                    <input type="color" id="user-theme-color" class="theme-color-input" value="#718096">
                                    <button type="button" id="save-theme-color-btn" class="btn btn-small btn-primary">‰øùÂ≠ò</button>
                                    <button type="button" id="reset-theme-color-btn" class="btn btn-small btn-secondary">„É™„Çª„ÉÉ„Éà</button>
                                </div>
                            </div>
                            <div class="theme-color-info">
                                <span id="theme-color-source">„Éá„Éï„Ç©„É´„Éà„Ç´„É©„Éº„Çí‰ΩøÁî®‰∏≠</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="sidebar-section">
                    <button type="button" id="sidebar-calendar-btn" class="sidebar-btn">
                        <span class="material-symbols-outlined">calendar_month</span>
                        <span class="sidebar-btn-text">„Ç´„É¨„É≥„ÉÄ„Éº</span>
                    </button>
                    <button type="button" id="sidebar-config-btn" class="sidebar-btn" style="display: none;">
                        <img src="images/settings.svg" alt="" class="material-icon">
                        <span class="sidebar-btn-text">Ë®≠ÂÆö</span>
                    </button>
                    <button type="button" id="sidebar-login-btn" class="sidebar-btn">
                        <img src="images/login.svg" alt="" class="material-icon">
                        <span class="sidebar-btn-text">„É≠„Ç∞„Ç§„É≥</span>
                    </button>
                    <button type="button" id="sidebar-logout-btn" class="sidebar-btn" style="display: none;">
                        <img src="images/logout.svg" alt="" class="material-icon">
                        <span class="sidebar-btn-text">„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                    </button>
                </div>

                <div class="sidebar-section" id="admin-section" style="display: none;">
                    <div class="sidebar-section-title">ÁÆ°ÁêÜ</div>
                    <button type="button" id="sidebar-department-btn" class="sidebar-btn active">
                        <img src="images/groups.svg" alt="" class="material-icon">
                        <span class="sidebar-btn-text">ÈÉ®ÁΩ≤ÁÆ°ÁêÜ</span>
                    </button>
                    <button type="button" id="sidebar-email-btn" class="sidebar-btn">
                        <span class="material-symbols-outlined">email</span>
                        <span class="sidebar-btn-text">„É°„Éº„É´Ë®≠ÂÆö</span>
                    </button>
                    <button type="button" id="sidebar-export-btn" class="sidebar-btn">
                        <span class="material-symbols-outlined">download</span>
                        <span class="sidebar-btn-text">„Éá„Éº„ÇøÂá∫Âäõ</span>
                    </button>
                    <button type="button" id="sidebar-import-btn" class="sidebar-btn">
                        <span class="material-symbols-outlined">upload</span>
                        <span class="sidebar-btn-text">„Éá„Éº„ÇøÂèñËæº</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- „Çµ„Ç§„Éâ„Éê„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <main class="main-content">
            <!-- „É¢„Éê„Ç§„É´Áî®„Éè„É≥„Éê„Éº„Ç¨„Éº„Éú„Çø„É≥ -->
            <button type="button" id="mobile-hamburger-btn" class="mobile-hamburger-btn">
                <span class="material-symbols-outlined">menu</span>
            </button>

            <div class="container">
                <div class="page-header">
                    <h1 class="page-title">ÈÉ®ÁΩ≤ÁÆ°ÁêÜ</h1>
                    <p class="page-description">ÈÉ®ÁΩ≤„ÅÆËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„ÇíË°å„Åà„Åæ„Åô</p>
                </div>

                <div id="loading" class="loading" style="display: none;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div id="error-message" class="error-message" style="display: none;"></div>
                <div id="success-message" class="success-message" style="display: none;"></div>


                <section>
                    <h2>Êñ∞„Åó„ÅÑÈÉ®ÁΩ≤„ÇíËøΩÂä†</h2>
                    <form id="add-department-form" class="">
                        <div class="form-row">
                            <label for="department-name">ÈÉ®ÁΩ≤Âêç:</label>
                            <input type="text" id="department-name" required>
                        </div>
                        <div class="form-row">
                            <label for="display-order">Ë°®Á§∫È†Ü:</label>
                            <input type="number" id="display-order" min="0">
                        </div>
                        <div class="form-row" id="color-input-row" style="display: none;">
                            <label for="department-color">„Éá„Éï„Ç©„É´„Éà„Ç´„É©„Éº:</label>
                            <input type="color" id="department-color" value="#718096">
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">ËøΩÂä†</button>
                        </div>
                    </form>
                </section>


                <div class="reservation-list-container">
                    <h2>ÈÉ®ÁΩ≤‰∏ÄË¶ß„ÉªÁ∑®ÈõÜ</h2>
                    <div id="departments-list" class="departments-list">
                        <!-- ÈÉ®ÁΩ≤„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/auth/auth.js"></script>
    <script src="../js/shared/header.js"></script>
    <script src="../js/shared/ui-utils.js"></script>
    <script src="../js/shared/user-theme-colors.js"></script>
    <script src="../js/department-management.js"></script>
    <script>
        // „Çµ„Ç§„Éâ„Éê„ÉºÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async function () {
            // Ë™çË®ºÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÊ≠£„Åó„ÅÑAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®Ôºâ
            try {
                const response = await fetch('../api/check_auth.php');
                const authStatus = await response.json();
                const isLoggedIn = authStatus.logged_in;

                if (isLoggedIn) {
                    // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö
                    currentUser = {
                        id: authStatus.user_id,
                        name: authStatus.session_data?.name || '„É¶„Éº„Ç∂„ÉºÂêç‰∏çÊòé',
                        role: authStatus.session_data?.role || 'user',
                        department: authStatus.session_data?.department || null,
                        lastUpdated: Date.now()
                    };

                    // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                    updateSidebarVisibility();

                    // ÈÉ®ÁΩ≤ÊÉÖÂ†±„ÇíË°®Á§∫
                    await updateSidebarDepartmentInfo();

                    // ÁÆ°ÁêÜËÄÖ„ÅÆÂ†¥Âêà„ÅØÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                    if (currentUser.role === 'admin') {
                        document.getElementById('admin-section').style.display = 'block';
                    }
                } else {
                    // Êú™„É≠„Ç∞„Ç§„É≥„ÅÆÂ†¥Âêà„ÅØ„É°„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                    window.location.href = '../index.html';
                }
            } catch (error) {
                console.error('Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÇÇ„É°„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                window.location.href = '../index.html';
            }

            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            setupSidebarListeners();

            // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº
            document.getElementById('mobile-hamburger-btn')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebar-overlay').style.display = 'block';
            });

            document.getElementById('hamburger-close-btn')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').style.display = 'none';
            });

            document.getElementById('sidebar-overlay')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').style.display = 'none';
            });
        });

        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞ÔºàË™çË®ºÁä∂ÊÖã„Å´Âøú„Åò„Å¶Ôºâ
        function updateSidebarVisibility() {
            const adminSection = document.getElementById('admin-section');
            const loginBtn = document.getElementById('sidebar-login-btn');
            const logoutBtn = document.getElementById('sidebar-logout-btn');
            const userSection = document.getElementById('sidebar-user-section');
            const userInfo = document.getElementById('sidebar-user-info');
            const configBtn = document.getElementById('sidebar-config-btn');
            const reservationsBtn = document.getElementById('sidebar-calendar-btn');

            if (currentUser) {
                // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'flex';
                userSection.style.display = 'block';

                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
                if (userInfo && currentUser) {
                    console.log('updateSidebarVisibility: Setting sidebar user info to:', currentUser.name);
                    userInfo.textContent = currentUser.name || '„É¶„Éº„Ç∂„ÉºÂêç‰∏çÊòé';
                }

                // ÁÆ°ÁêÜËÄÖ„ÅÆÂ†¥Âêà„ÅØÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                if (currentUser.role === 'admin') {
                    adminSection.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                }

                // „Ç´„É¨„É≥„ÉÄ„Éº„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´Ë®≠ÂÆö
                setActiveSidebarBtn('sidebar-department-btn');
            } else {
                // Êú™„É≠„Ç∞„Ç§„É≥
                loginBtn.style.display = 'flex';
                logoutBtn.style.display = 'none';
                adminSection.style.display = 'none';
                userSection.style.display = 'none';
                if (configBtn) configBtn.style.display = 'none';
                if (reservationsBtn) reservationsBtn.style.display = 'none';
            }
        }

        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥„ÇíË®≠ÂÆö
        function setActiveSidebarBtn(btnId) {
            // ÂÖ®„Å¶„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ÊåáÂÆö„Åï„Çå„Åü„Éú„Çø„É≥„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
            document.getElementById(btnId)?.classList.add('active');
        }

        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆÈÉ®ÁΩ≤ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        async function updateSidebarDepartmentInfo() {
            if (!currentUser) return;

            const departmentNameElement = document.getElementById('sidebar-department-name');
            if (!departmentNameElement) return;

            try {
                const deptResponse = await fetch('../api/departments.php');
                const deptResult = await deptResponse.json();

                if (deptResult.success && currentUser.department) {
                    const dept = deptResult.departments.find(d => d.id == currentUser.department);
                    if (dept) {
                        departmentNameElement.textContent = dept.name;
                        return;
                    }
                }

                departmentNameElement.textContent = 'ÈÉ®ÁΩ≤Êú™Ë®≠ÂÆö';
            } catch (error) {
                console.error('ÈÉ®ÁΩ≤ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
                departmentNameElement.textContent = 'ÈÉ®ÁΩ≤Êú™Ë®≠ÂÆö';
            }
        }

        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupSidebarListeners() {
            // „Ç´„É¨„É≥„ÉÄ„Éº„Éú„Çø„É≥
            document.getElementById('sidebar-calendar-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-calendar-btn');
                window.location.href = '../index.html';
            });

            // ÈÉ®ÁΩ≤ÁÆ°ÁêÜ„Éú„Çø„É≥
            document.getElementById('sidebar-department-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-department-btn');
                // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Å™„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            });

            // „É°„Éº„É´Ë®≠ÂÆö„Éú„Çø„É≥
            document.getElementById('sidebar-email-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-email-btn');
                window.location.href = 'email_notification_admin.html';
            });

            // „Éá„Éº„ÇøÂá∫Âäõ„Éú„Çø„É≥
            document.getElementById('sidebar-export-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-export-btn');
                window.location.href = 'csv_export.html';
            });

            // „Éá„Éº„ÇøÂèñËæº„Éú„Çø„É≥
            document.getElementById('sidebar-import-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-import-btn');
                window.location.href = 'csv_import.html';
            });

            // Ë®≠ÂÆö„Éú„Çø„É≥
            document.getElementById('sidebar-config-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-config-btn');
                window.location.href = '../config.html';
            });

            // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥
            document.getElementById('sidebar-login-btn')?.addEventListener('click', () => {
                setActiveSidebarBtn('sidebar-login-btn');
                window.location.href = '../index.html';
            });

            // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
            document.getElementById('sidebar-logout-btn')?.addEventListener('click', () => {
                if (commonHeader) {
                    commonHeader.handleLogout();
                }
            });
        }
    </script>
</body>

</html>